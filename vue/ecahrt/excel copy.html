<!DOCTYPE html>
<html lang="zh">


<head>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js
"></script>
    <meta charset="UTF-8">
    <title>图像生成</title>
</head>
<link href="./layui.css" rel="stylesheet">
<script src="./layui.js"></script>

<body>

    <div class="layui-layout layui-layout-admin">
        <div class="layui-header">
            <div class="layui-logo layui-hide-xs layui-bg-black">数据图像处理系统</div>
            <ul class="layui-nav layui-layout-left">
                <li class="layui-nav-item layui-hide-xs"><a href="excelChart.html">图像生成</a></li>
                <li class="layui-nav-item layui-hide-xs  layui-this"><a href="excel copy.html">数据展示</a></li>
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li>
                    <div style="color: white;margin-top: 20px;" id="showTime">2018/6/12 17:00:12</div>
                </li>
            </ul>
        </div>
    </div>

    <div class="layui-panel" style="margin-top: 60px;">
        <div class="layui-form" style="margin-top: 30px;">
            <!-- 图表配置 -->
            <div class="layui-row">
                <div class="layui-col-xs8">
                    <div class="layui-form-item">
                        <div class="layui-row grid-demo">
                            <div class="layui-col-md6">
                                <label class="layui-form-label" style="width: 60px;">最大值</label>
                                <div class="layui-input-inline" style="width: 100px;">
                                    <input id="max" type="number" autocomplete="off" class="layui-input" step="1"
                                        lay-affix="number" value="60">
                                </div>
                                <label class="layui-form-label" style="width: 60px;">最小值</label>
                                <div class="layui-input-inline" style="width: 100px;">
                                    <input id="min" type="number" autocomplete="off" class="layui-input" step="1"
                                        lay-affix="number" value="40">
                                </div>
                                <button type="button" class="layui-btn" onclick="changeMaxAndMin()">提交</button>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">间距</label>
                                    <div class="layui-input-inline" style="width: 100px;">
                                        <input id="spance" type="number" autocomplete="off" class="layui-input" step="1"
                                            lay-affix="number" value="5">
                                    </div>
                                    <button type="button" class="layui-btn" onclick="changeSpance()">确认</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs4">
                    <label class="layui-form-label" style="width: 60px;">选择文件</label>
                    <input style="margin-top: 5px;" id="file" type="file" accept=".xlsx, .csv" multiple>
                    <button type="button" class="layui-btn" onclick="getDataFromFile()">提交</button>
                </div>
            </div>

            <div class="layui-row">
                <div class="layui-col-xs9" style="margin-left: 30px;">
                    <div class="layui-form-item">
                        <sapn>当前数据量为：<span id="readSize">0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></sapn>
                    </div>
                </div>
                <div class="layui-col-xs1">
                    <div class="layui-form-item">
                        <button type="button" class="layui-btn layui-btn-sm layui-btn-normal"
                            onclick="getNowData()">导出当前图表数据</button><br>
                    </div>
                </div>
                <div class="layui-col-xs1">
                    <!-- 下载按钮 -->
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-normal"
                        onclick="downloadChart()">下载图表</button>
                </div>
            </div>
            <!-- 图表 -->
            <div id="main" style="height: 550px;width: 100%;"></div>
            
            <selct id="tableTitle"></selct>
        </div>
    </div>

    <!-- 进度条 -->
    <div id="showProgress" style="display: none;">
        <div style="padding:16px;" style="display: none;">
            <div class='layui-progress layui-progress-big' lay-showpercent="true" lay-filter='progressDemo'>
                <div class='layui-progress-bar' lay-percent='0%'></div>
            </div>
        </div>
    </div>

</body>

<script src="./echarts.min.js"></script>

<script type="text/javascript">

    //解析后数据
    var mydata;
    //原始数据（未解码数据）
    var originalData;
    //图表配置
    var option;
    //数据量
    var size;
    //图标div
    var main = document.querySelector("#main")
    var chart = echarts.init(main)

    //切换纵轴区间
    function changeMaxAndMin() {

        //获取输入框内的最大值和最小值
        var showMax = document.getElementById("max").value
        var showMin = document.getElementById("min").value

        //非空判断
        if (showMax == null || showMax == 0) {
            showMax = 60
        }
        if (showMin == null || showMin == 0) {
            showMin = 40
        }

        //修改大小值
        option.yAxis.max = showMax;
        option.yAxis.min = showMin;
        // 使用 setOption 刷新图表的配置
        chart.setOption(option);

    }


    //改变间距
    function changeSpance() {

        //获取输入框的刻度间隔
        var spance = document.getElementById("spance").value
        spance = spance && parseInt(spance); // 将字符串转换为数字

        if (spance != null || spance != 0) {
            //修改刻度间隔
            option.yAxis.interval = spance;
            // 使用 setOption 刷新图表的配置
            chart.setOption(option);
        }

    }

    //获取文件数据
    function getDataFromFile() {
        new Promise((resolve, reject) => {

            // 进度条更新
            var progressBar = showProgressBar();
            updateProgressBar(progressBar, "10%", "文件上传中"); // 更新进度条为 10%


            //初始化size的值
            size = 0;
            //获取输入框的内容
            var fileInput = document.getElementById("file")
            //获取其所有文件
            var files = fileInput.files;
            updateProgressBar(progressBar, "20%", "数据获取中");

            //如果文件数小于50
            if (files.length < 10) {
                // 创建 FormData 对象，并将文件附加到表单数据中
                const formData = new FormData

                for (var i = 0; i < files.length; i++) {
                    formData.append('file', files[i]);
                    // var progress = Math.floor((i / files.length) * 100*0.3);  // 计算进度百分比并取整
                    // var progressString = `${progress}%`;
                }
                updateProgressBar(progressBar, "30%", "读取文件中")

                // 使用 Axios 发送 POST 请求
                axios.post('http://localhost:8165/excel/file', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data' // 设置请求头为multipart/form-data
                    }
                }).then(function (response) {

                    updateProgressBar(progressBar, "60%", "数据解析中");
                    //转换数据格式为float
                    mydata = response.data.data.map(function (str) {
                        return parseFloat(str); // 使用parseFloat将字符串转化为浮点数
                        // 如果你需要将字符串转化为整数，可以使用parseInt(str)而不是parseFloat(str)
                    });

                    console.log(mydata)

                    //获取未解码数据和数据量
                    originalData = response.data.originalData
                    size = parseInt(response.data.size)

                    document.getElementById("readSize").innerHTML = size;


                    //   指定图标option配置项和数据
                    option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: function (params) {
                                var index = params[0].dataIndex; // 获取鼠标悬浮点的索引
                                return '数据: ' + mydata[index]; // 只显示一个点的数据
                            }
                        },
                        xAxis: {
                            type: 'category',
                            show: false,
                            // 使用 data 数组中的索引作为 x 轴标签
                            data: mydata.map(function (value, index) {
                                return index;
                            }),
                        },
                        yAxis: {
                            // y 轴类型为数值
                            type: 'value',
                            max: 60,
                            min: 40,
                            interval: 5,
                        },
                        series: [{
                            type: 'line',
                            symbol: 'circle',
                            smooth: true,
                            label: {
                                show: false, // 初始时不显示标签
                                formatter: '{c}' // 显示y轴数据
                            },
                            data: mydata,
                            //线条颜色
                            itemStyle: {
                                color: '#00acec'
                            },

                        }]

                    }


                    chart.setOption(option)
                    updateProgressBar(progressBar, "100%", "加载完成");
                })


            } else if (files.length >= 10) {

                var number = 0;
                readManyFile(files, number, progressBar);

            }


        })
    }

    getData();

    //获取服务器数据
    function getData() {
        new Promise((resolve, reject) => {

            //发送请求
            axios.post('http://121.37.39.206:8165/excel/getData')
                .then(function (response) {

                    mydata = response.data.data.map(function (str) {
                        return parseFloat(str); // 使用parseFloat将字符串转化为浮点数
                        // 如果你需要将字符串转化为整数，可以使用parseInt(str)而不是parseFloat(str)
                    });

                    console.log(mydata)

                    //   指定图标option配置项和数据
                    option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: function (params) {
                                var index = params[0].dataIndex; // 获取鼠标悬浮点的索引
                                return '数据: ' + mydata[index]; // 只显示一个点的数据
                            }
                        },
                        xAxis: {
                            type: 'category',
                            show: false,
                            // 使用 data 数组中的索引作为 x 轴标签
                            data: mydata.map(function (value, index) {
                                return index;
                            }),

                        },
                        yAxis: {
                            // y 轴类型为数值
                            type: 'value',
                            max: 60,
                            min: 40,
                            interval: 5,
                        },
                        series: [{
                            //图标类型---折线图
                            type: 'line',
                            symbol: 'circle',
                            smooth: true,
                            label: {
                                show: false, // 初始时不显示标签
                                formatter: '{c}' // 显示y轴数据
                            },
                            data: mydata,
                            //线条颜色
                            itemStyle: {
                                color: '#00acec'
                            },

                        }]

                    }

                    // 使用刚指定的配置项和数据显示图标
                    chart.setOption(option)
                })

        })
    }

    //导出当前图标数据
    function getNowData() {
        new Promise((resolve, reject) => {

            //判断是否为空
            if (mydata == null || originalData == null) {
                return fasle;
            }

            //转为string类型数据，防止精度丢失
            var stringTemperatureData = mydata.map(value => value.toString());

            //封装json数据
            var data = {
                excelData: stringTemperatureData,
                original: originalData
            }

            //发送获取当前图标数据的请求
            axios.post('http://121.37.39.206:8165/excel/getNowData', data)
                .then(function (response) {

                    //获取文件url
                    const fileUrl = response.data.url;

                    //利用a标签下载
                    let a = document.createElement('a');
                    a.style.display = 'none';
                    //设置url
                    a.href = fileUrl
                    //设置文件名
                    a.download = response.data.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a)

                })
        })

    }


    function readManyFile(files, number, progress) {

        // 创建 FormData 对象，并将文件附加到表单数据中
        const formData = new FormData();

        var total = number + 10

        for (number; number < total; number++) {
            if (number < files.length - 1) {
                formData.append('file', files[number]);
            }
        }

        // 计算进度百分比并取整
        var progress = Math.floor((number / files.length) * 100 * 0.4);
        var progressString
        if (progress >= 40) {
            progressString = "100%"
        } else {
            progressString = `${progress + 60}%`;
        }
        var text = "解析数据" + total.toString() + "/" + files.length.toString();
        console.log(text)
        updateProgressBar(progress, progressString, text);

        console.log(number)

        // 使用 Axios 发送 POST 请求
        axios.post('http://121.37.39.206:8165/excel/file', formData, {
            headers: {
                'Content-Type': 'multipart/form-data' // 设置请求头为multipart/form-data
            }
        }).then(function (response) {

            //转换数据格式为float
            tempData = response.data.data.map(function (str) {
                return parseFloat(str); // 使用parseFloat将字符串转化为浮点数
                // 如果你需要将字符串转化为整数，可以使用parseInt(str)而不是parseFloat(str)
            });
            console.log("分批数据：" + tempData);
            mydata = tempData.concat(mydata)

            //获取未解码数据和数据量
            originalData = response.data.originalData.concat(originalData)
            size += parseInt(response.data.size)


            if (number + 10 >= files.length) {

                console.log("总原始数据：" + originalData);
                console.log("总数据" + mydata);
                console.log(size)
                document.getElementById("readSize").innerHTML = size;

                chart.showLoading();
                //   指定图标option配置项和数据
                option = {
                    animation: false,
                    xAxis: {
                        type: 'category',
                        show: false,
                        // 使用 data 数组中的索引作为 x 轴标签
                        data: mydata.map(function (value, index) {
                            return index;
                        }),
                    },
                    yAxis: {
                        // y 轴类型为数值
                        type: 'value',
                        max: 60,
                        min: 40,
                        interval: 5,
                    },
                    series: [{
                        type: 'line',
                        large: true,
                        sampling: 'average',
                        data: mydata,
                    }]

                }

                chart.setOption(option)
                chart.hideLoading();
                console.log("读取执行完成")
                updateProgressBar(progress, "100%", "读取完毕");
                setTimeout(function () {
                    layui.layer.close(progress);
                    layui.element.init();
                }, 700);

            }

            if (number + 10 < files.length - 1) {
                readManyFile(files, number)
            }

        })
    }

    // 保存为图片函数
    function downloadChart() {
        // 使用 ECharts 提供的 getConnectedDataURL 方法获取图片数据URL
        var imgDataURL = chart.getConnectedDataURL({
            type: 'png', // 保存为 PNG 格式
            pixelRatio: 2, // 可以调整分辨率
            backgroundColor: '#fff', // 图片背景颜色
        });

        // 创建一个虚拟链接并触发下载
        var link = document.createElement('a');
        link.href = imgDataURL;
        link.download = 'echarts_chart.png';
        link.click();
    }

    // 设置系统时间
    var t = null;
    t = setTimeout(time, 1000);//開始运行
    function time() {
        clearTimeout(t);//清除定时器
        dt = new Date();
        var y = dt.getFullYear();
        var mt = dt.getMonth() + 1;
        var day = dt.getDate();
        var h = dt.getHours();//获取时
        var m = dt.getMinutes();//获取分
        var s = dt.getSeconds();//获取秒
        document.getElementById("showTime").innerHTML = y + "年" + mt + "月" + day + "日 " + h + ":" + m + ":" + s + "";
        t = setTimeout(time, 1000); //设定定时器，循环运行     
    }


    // 使用 layui 进度条组件显示加载条
    function showProgressBar() {
        var progressBar = layui.layer.open({
            type: 1,
            title: "文件上传中",
            area: ['400px', '20%'],
            shade: false,
            content: layui.$('#showProgress'),
        });
        layui.element.init();

        return progressBar;
    }

    // 更新进度条
    function updateProgressBar(progressBar, percent, text) {
        layui.element.progress("progressDemo", percent);
        layui.layer.title(text, progressBar);
        if (percent == "100%") {
            setTimeout(function () {
                layui.layer.close(progressBar);
            }, 700);
        }
        layui.element.init();
    }

    // 时间函数
    var t = null;
    t = setTimeout(time, 1000);//開始运行
    function time() {
        clearTimeout(t);//清除定时器
        dt = new Date();
        var y = dt.getFullYear();
        var mt = dt.getMonth() + 1;
        var day = dt.getDate();
        var h = dt.getHours();//获取时
        var m = dt.getMinutes();//获取分
        var s = dt.getSeconds();//获取秒
        document.getElementById("showTime").innerHTML = y + "年" + mt + "月" + day + "日 " + h + ":" + m + ":" + s + "";
        t = setTimeout(time, 1000); //设定定时器，循环运行     
    }
</script>

</html>