<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<title>登录界面</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<!-- layui css -->
	<link href="https://www.layuicdn.com/layui/css/layui.css" rel="stylesheet">
	<!-- login css -->
	<link rel="stylesheet" type="text/css" href="../css/login.css" media="all">

</head>

<body>
	<div class="layui-container">
		<div class="admin-login-background">
			<div class="layui-canvs"> </div>
			<div class="layui-layout layui-layout-login" style="background-color: white;width: 450px;">

				<div class="layui-tab layui-tab-brief" lay-filter="roleSelect" style="width: 100%">


					<ul class="layui-tab-title">
						<li class="layui-this" style="width: 40%;">测试登录</li>
						<li style="width: 46%;">开发登录</li>
					</ul>


					<div class="layui-tab-content" style="margin-left: 50px;
					margin-right: 50px; ">

						<!-- 选项卡---用户登录 -->
						<div class="layui-tab-item layui-show" style="width: 350px;">

							<!-- 系统名称艺术字 -->
							<h1>
								<strong style="font-size: 20px;">软件测试版本管理系统</strong>
								<em style="font-size: 10px;">Software Testing Version Control System</em>
							</h1>

							<!-- 提示词 -->
							<small
								style="color: #16b777;margin-left: 120px;margin-bottom: 30px;">请使用<b>测试</b>账号登录</small>

							<!-- 登录框 -->
							<div class="layui-user-icon larry-login ">
								<input type="text" id="userName" placeholder="账号" class="login_txtbx" />
							</div>
							<div class="layui-form">
								<div class="layui-pwd-icon larry-login layui-input-wrap">
									<input type="password" id="userPassword" lay-affix="eye" placeholder="密码"
										class="login_txtbx">
								</div>
							</div>
							<div class="layui-form" style="margin-left: 250px;">
								<input id="remeberUser" type="checkbox" name="AAA" title="记住密码">
							</div>
							<div class="layui-submit larry-login">
								<button type="button" class="submit_btn" onclick="login(1)">立即登录</button>
							</div>



							<!-- 系统logo -->
							<div class="layui-login-text">
								<p style="color: black;font-size: 12px;font-family: 微软雅黑;font-weight: bold;"><a
										href="http://demo.larrycms.com" title=""><img src="./images/bingling.png"
											width="60" height="30" style="margin-left: 10px;"></a></p>
							</div>

						</div>

						<!-- 选项卡---开发人员界面登录 -->
						<div class="layui-tab-item" style="width: 350px;">

							<!-- 系统名称 -->
							<h1>
								<strong style="font-size: 20px;">软件测试版本管理系统</strong>
								<em style="font-size: 10px;">Software Testing Version Control System</em>
							</h1>

							<!-- 提示词 -->
							<small
								style="color: #16b777;margin-left: 120px;margin-bottom: 30px;">请使用<b>开发</b>账号登录</small>


							<!-- 登录框 -->
							<div class="layui-user-icon larry-login ">
								<input type="text" id="managerName" placeholder="账号" class="login_txtbx" />
							</div>
							<div class="layui-form">
								<div class="layui-pwd-icon larry-login layui-input-wrap">
									<input type="password" id="managerPassword" lay-affix="eye" placeholder="密码"
										class="login_txtbx">
								</div>
							</div>
							<div class="layui-form" style="margin-left: 250px;">
								<input id="remeberManager" type="checkbox" name="AAA" title="记住密码">
							</div>
							<div class="layui-submit larry-login">
								<button type="button" class="submit_btn" onclick="login(2)">立即登录</button>
							</div>



							<!-- 系统logo -->
							<div class="layui-login-text">
								<p style="color: black;font-size: 12px;font-family: 微软雅黑;font-weight: bold;"><a
										href="http://demo.larrycms.com" title=""><img src="./images/bingling.png"
											width="60" height="30" style="margin-left: 10px;"></a></p>
							</div>


						</div>

					</div>
				</div>
			</div>



		</div>
	</div>
	</div>

</body>

<script src="../js/axios.main.js"></script>
<script src="../js/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="https://www.layuicdn.com/layui/layui.js"></script>
<script src="../js/jquery.particleground.min.js" charset="utf-8"></script>

<script lang="text/javascript">



	layui.use(['form'], function () {
		var form = layui.form,
			layer = layui.layer;

		// 登录过期的时候，跳出ifram框架
		if (top.location != self.location) top.location = self.location;

		// 粒子线条背景
		$(document).ready(function () {
			$('.layui-container').particleground({
				dotColor: '#7ec7fd',
				lineColor: '#7ec7fd'
			});
		});
	})

	// 界面初始化操作
	window.onload = function () {

		// 获取已保存的账号密码
		var userName = localStorage.getItem("userName");
		var userPWD = localStorage.getItem("userPWD");
		var managerName = localStorage.getItem("managerPWD");
		var managerPWD = localStorage.getItem("managerPWD");

		if (userName != '' && userPWD != '') {
			document.getElementById('userName').value = userName
			document.getElementById('userPassword').value = userPWD
		}
		if (managerName != '' && managerPWD != '') {
			document.getElementById('managerName').value = managerName
			document.getElementById('managerPassword').value = managerPWD
		}


	};


	// 登录函数
	function login(role) {

		// 如果权限为用户
		if (role == 1) {

			//获取数据
			var username = document.getElementById('userName').value
			var userPWD = document.getElementById('userPassword').value

			if (username == '') {
				tell("用户名为空")
				return null
			} else if (userPWD == '') {
				tell("密码为空")
				return null
			} else {
				// 保存账号密码
				var remeberUser = document.getElementById("remeberUser")
				// 选中记住密码则添加数据
				if (remeberUser.checked) {
					localStorage.setItem("userName", username)
					localStorage.setItem("userPWD", userPWD)
					// 未选记住密码则删除数据
				} else if (!remeberUser.checked) {
					localStorage.removeItem("userName")
					localStorage.removeItem("userPWD")
				}
				toLogin(username, userPWD)
			}



		}

		//如果权限为开发人员
		if (role == 2) {

			// 获取数据
			var managerName = document.getElementById('managerName').value
			var managerPWD = document.getElementById('managerPassword').value

			if (managerName == '') {
				tell("用户名为空")
				return null;
			} else if (managerPWD == '') {
				tell("密码为空")
				return null;
			} else {
				// 保存账号密码
				var remeberUser = document.getElementById("remeberManager")
				// 选中记住密码则添加数据
				if (remeberUser.checked) {
					localStorage.setItem("managerName", managerName);
					localStorage.setItem("managerPWD", managerPWD)
				} else if (!remeberUser.checked) {
					// 未选记住密码则删除数据
					localStorage.removeItem("managerName")
					localStorage.removeItem("managerPWD")
				}
				//请求数据，进行登录验证
				toLogin(managerName, managerPWD)
			}

		}

	}

	//警示信息函数
	function tell(msg) {
		layui.use(function () {
			var layer = layui.layer;
			var util = layui.util;
			layer.msg(msg, { icon: 0 }, function () {
				// layer.msg('提示框关闭后的回调');
			});
		})
	}

	var nowSelectRole = 0;
	layui.use(function () {
		var element = layui.element;
		// 切换事件
		element.on('tab(roleSelect)', function (obj) {
			nowSelectRole = obj.index;
			console.log(nowSelectRole);
		});
	});

	//登录
	function toLogin(username, pwd) {
		return new Promise((resolve, reject) => {
			//mapId封装成json
			var data = {
				"username": username,
				"password": pwd
			};

			axios.post('http://localhost:8180/user/login', data)
				.then(function (response) {
					if (response.data.code == 200) {

						localStorage.setItem("userId", response.data.data.id);

						if (response.data.data.role == 0 && nowSelectRole == 0) {
							window.location.href = "userIndex.html"
						}
						if (response.data.data.role == 0 && nowSelectRole == 1) {
							tell("请登录开发人员账号")
						}
						if (response.data.data.role == 1 && nowSelectRole == 1) {
							window.location.href = "managerIndex.html"
						}
						if (response.data.data.role == 1 && nowSelectRole == 0) {
							tell("请登录测试人员账号")
						}
					} else {
						tell("账号或密码错误，请重新输入");
					}
				})
				.catch(function (error) {
					console.error('请求失败');
					reject(error);
				})

		})
	}
</script>

</html>